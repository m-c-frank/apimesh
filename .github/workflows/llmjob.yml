name: Process Issue and Generate Solutions

on:
  issues:
    types: [opened, reopened]

jobs:
  generate-solutions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Prepare Prompt
        run: |
          ISSUE_TITLE=$(jq -r .issue.title < $GITHUB_EVENT_PATH)
          ISSUE_BODY=$(jq -r .issue.body < $GITHUB_EVENT_PATH)
          PROMPT="Issue Title: $ISSUE_TITLE\nIssue Description: $ISSUE_BODY\nProvide a clear and concise answer in Markdown format, suggesting three to four creative and orthogonal ways to implement or address this issue."
          echo "PROMPT=$PROMPT" >> $GITHUB_ENV

      - name: Generate OpenAI response
        run: |
          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d "{\"model\": \"gpt-3.5-turbo\", \"prompt\": \"$PROMPT\", \"max_tokens\": 150, \"temperature\": 0.7}")

          ANSWER=$(echo $RESPONSE | jq -r .choices[0].text)
          
          echo "$ANSWER"
          echo "ANSWER=$ANSWER" >> $GITHUB_ENV
        env:
          API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Create README
        run: |
          echo "$ANSWER" > SOLUTIONS_README.md
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git checkout llmjob
          git add SOLUTIONS_README.md
          git commit -m 'Add generated solutions README'
          git push --set-upstream origin llmjob -u $GH_PAT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

