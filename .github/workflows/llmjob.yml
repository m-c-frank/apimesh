name: Process Issue and Generate Solutions

on:
  issues:
    types: [opened, reopened]

jobs:
  generate-solutions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate OpenAI response
        run: |
          ISSUE_TITLE="Issue Title: ${{ steps.issue_info.outputs.title }}"
          ISSUE_NUMBER="Issue Number: ${{ steps.issue_info.outputs.number }}"
          ISSUE_BODY="Issue Body: ${{ steps.issue_info.outputs.body }}"
          

          PROMPT="issue title: $ISSUE_TITLE\nissue number: $ISSUE_NUMBER\nISSUE_BODY=$ISSUE_BODY"
          echo "$PROMPT"
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -d '{
                "model": "gpt-3.5-turbo",
                "messages": [
                  {
                    "role": "system",
                    "content": "You are a helpful assistant."
                  },
                  {
                    "role": "user",
                    "content": "'$PROMPT'"
                  },
                ]
              }
          )
          echo "$RESPONSE"

          ANSWER=$(echo $RESPONSE | jq -r .choices[0].message.content)
          
          echo "$ANSWER"

          echo "$ANSWER" > SOLUTIONS_README.md
          gh auth login --with-token $GH_PAT 
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git checkout -b llmjob
          git push origin llmjob
          git add SOLUTIONS_README.md
          git commit -m 'Add generated solutions README'
          git push --set-upstream origin llmjob
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          API_KEY: ${{ secrets.OPENAI_API_KEY }}

